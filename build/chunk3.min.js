function setup(){pixelDensity(4),noiseSeed(5e4*random()),randomSeed(5e3*random()),cnv=createCanvas(DIM*ratio,DIM),width=DEFAULT_SIZE*ratio,height=DEFAULT_SIZE,background(0),overallTexture=createGraphics(width,height,WEBGL),overallTexture.shader(shTxt),shTxt.setUniform("u_resolution",[width,height]),overallTexture.rect(-width/2,-height/2,width,height),wC=createGraphics(width,height,WEBGL),oG=createGraphics(width,height),olayG=createGraphics(width,height),wC.noStroke(),olayG.noStroke(),oG.noStroke();let e=random([-.1,-.05,0,0,.05,.1])*width,t=random([-.1,-.05,0,0,.05,.1])*height,o=random([-.2,-.1,.1,.2]),r=random([1.05,1.1,1.15,1.2]);for(let i of[oG,olayG])i.translate(e,t),i.translate(width/2,height/2),i.rotate(o),i.scale(r),i.translate(-width/2,-height/2);background(100),oG.noStroke(),bgColor=color(random(colors)),random()<.5&&(bgColor=color(random([sortedColors[0],sortedColors.slice(-1)[0]]))),"glow"==features.style&&(bgColor=color(0)),"pure"==features.style&&(bgColor=color(colors[2]));let i=int(random(7)),s=[10,12,16,20,32,44,60,68,72],a=[250,300,350,400,550,600,740,800,900],n=features.minPairId,h=features.maxPairId,l=s[i],d=a[i],c=random([10,20,100,200]),p=random([.05,.3]),u=random([150,200,250,300]),m=random([.35,.4,.45,.5]);random([0,1,2,5,10,15,20,25]),random([0,0,random([0,5,10,15])]);if("natural"==features.layout)for(let e=0;e<=width;e+=l){if(noise(e/2)<p)continue;let t="rect"==features.shapeType?-.75:-.8;if(!(sin(e+seed*PI)<t))for(let t=0;t<=height;t+=l){if(noise(e/u,t/u)<=m)continue;particles.push(new Particle({p:createVector(e,t),r:noise(e,t)*d*random(1),color:colors[int(noise(e/u*2,t/u*2)*colors.length*2)%colors.length]}));let o=int(map(noise(e/c,t/c),0,1,n,h));l=s[o],d=a[o]}}else if("ring"==features.layout||"pie"==features.layout){let e=map(noise(seed),0,1,.25,.4)*width,t=map(noise(seed+1),0,1,.5,.7)*width,o=width/2,r=height/2;"pie"==features.layout&&(manRingR=0,o=random([0,1])*width,r=random([0,1])*height,e=width/3,t=map(noise(seed+1),0,1,1,1.1)*width,l*=.9);for(var f=0;f<=2*PI;f+=.1)for(var g=e;g<t;g+=l){let e=g*cos(f)+o,t=g*sin(f)+r,i=1.5*sqrt(g)+noise(e,t)*d/1.5*random(1);if(noise(e/u,t/u)<=m/1.5)continue;particles.push(new Particle({p:createVector(e,t),r:i,color:colors[int(noise(g/u*1.5,1.5*f)*colors.length*2)%colors.length]}));let p=int(map(noise(e/c,t/c),0,1,n,h));l=s[p],d=a[p]}for(let t=0;t<50;t++)particles.push(new Particle({p:createVector(width/2+random(.3*-e,.3*e),height/2+random(.3*-e,.3*e)),r:random(e/1.9),color:random(colors)}))}else if("blocks"==features.layout){let e=map(noise(seed),0,1,.1,.15)*width,t=map(noise(seed+1),0,1,.3,.5)*height,o="rect"==features.shapeType||"polygon"==features.shapeType?1*d:d,r=random()<.5;for(let i=-1;i<=1;i++)for(var w=-e;w<e;w+=l)for(var y=-t;y<t;y+=l){let p=w+i*e*3+width/2,m=y+i*t/2+height/2;if(r){let e=p;p=m,m=e}particles.push(new Particle({p:createVector(p,m),r:noise(w,y)*o*random(1)*random(1),color:colors[int(noise(p/u,m/u,500*i)*colors.length*4)%colors.length]}));let f=int(map(noise(w/c,y/c),0,1,n,h));l=s[f],d=a[f]}}else if("spiral"==features.layout){let e=map(noise(5*seed),0,1,.65,1.05),t=(map(noise(seed),0,1,.1,.15),width,map(noise(seed+1),0,1,.3,.5),height,"rect"==features.shapeType?1.2*d:(features.shapeType,1.25*d)),o=0;for(let r=0;r<.6*width;r+=l/2)for(let i=0;i<=.15*PI;i+=.05){let p=e*(r+noise(500*i)*r*.6+map(i,PI/2,PI,0,1,!0)*noise(100*r)*width/1.2),m=p*cos(i+o*PI+r/40)+width/2,f=p*sin(i+o*PI+r/40)+height/2;particles.push(new Particle({p:createVector(m,f),r:1.5*sqrt(r)+noise(r/4,i/4)*t*random(1)*random(1),color:colors[int(noise(r/u,2*i)*colors.length*3)%colors.length]}));let g=int(map(noise(w/c,y/c),0,1,n,h));l=s[g],d=a[g]}}else if("chess"==features.layout){let e=random([0,1]);for(let t=0;t<=width;t+=l){if(noise(t/2)<p)continue;features.shapeType;for(let o=0;o<=height;o+=l){let r=random([2,3]),i=int(t/(width/r)),u=int(o/(height/r));if((i+u+e)%2==1)continue;if(noise(t,o)<p)continue;particles.push(new Particle({p:createVector(t,o),r:(.5+noise(t,o)/2)*d/2*random(1),color:colors[max(int(i*colors.length/3+u*colors.length/3+noise(t/m,o/m)*colors.length),0)%colors.length]}));let f=int(map(noise(t/c,o/c),0,1,n,h));l=s[f],d=a[f]}}}for(let e=0;e<features.wormholeCount;e++){let e=new Wormhole({p:createVector(random(.2*-width,1.2*width),random(.2*-height,1.2*height)),r:random(100,600),intensity:random([-1,1])/10,rotate:random([-1,1]),attract:random([-1,1])});wormholes.push(e)}}function draw(){scale(M),wC.shader(sh1),sh1.setUniform("u_resolution",[width,height]),sh1.setUniform("u_time",millis()/1e3),sh1.setUniform("u_mouse",[mouseX/width,mouseY/height]),sh1.setUniform("u_tex",oG),sh1.setUniform("u_bgColor",[bgColor._getRed()/255,bgColor._getGreen()/255,bgColor._getBlue()/255]),sh1.setUniform("u_canvas_tex",overallTexture),sh1.setUniform("u_distortFactor",features.distortFactor),sh1.setUniform("u_hasBorder",features.hasBorder),wC.clear(),background(100),fill(0),rect(0,0,2*width,2*height),wC.rect(-width/2,-height/2,width,height),particles.forEach((e=>{e.update(),e.draw(oG)})),particles=particles.filter((e=>e.alive)),oG.noStroke(),fill(bgColor),rect(0,0,width,height);let e=20;if(push(),features.hasGrid){if("rect"==features.shapeType){push(),blendMode(MULTIPLY);for(let t=-40;t<=width+e;t+=e)stroke(0,20),line(t,0,t,height);for(let t=-40;t<=height+e;t+=e)stroke(0,20),line(0,t,width,t);pop()}if("ellipse"==features.shapeType){blendMode(BLEND);for(var t=0;t<3;t++){push(),strokeWeight(1),translate(width/2,height/2),rotate(t/3*PI*2),translate(-width/2,-height/2);for(let e=-160;e<=width+80;e+=50)stroke(255,80),line(e,0,e,height+200);pop()}}}image(wC,0,0),push(),image(olayG,0,0),pop(),pop(),push(),blendMode(MULTIPLY),noStroke(),image(overallTexture,0,0),pop()}function keyPressed(){"s"==key&&saveCanvas(tokenData.hash+".png"),"b"==key&&(features.hasBorder=!features.hasBorder)}
